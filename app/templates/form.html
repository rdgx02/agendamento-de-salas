<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agendamento de Salas</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body.oculto {
      display: none;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
      background: #f2f4f8;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-top: 40px;
    }

    form {
      background: #ffffff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 500px;
      margin: auto;
    }

    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    button {
      background-color: #3498db;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #2980b9;
    }

    .mensagem-erro {
      color: #c0392b;
      font-weight: bold;
      margin: 20px auto;
      background: #fcecec;
      border: 1px solid #e0b4b4;
      padding: 12px;
      border-radius: 8px;
      max-width: 500px;
      text-align: center;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body class="oculto">
  <h1>Agendar Sala de Reuni√£o</h1>

  {% if mensagem %}
    <div id="erro" class="mensagem-erro">{{ mensagem }}</div>
  {% else %}
    <div id="erro" class="mensagem-erro hidden"></div>
  {% endif %}

  <form method="POST">
    <label>Nome:</label>
    <input type="text" id="nome" name="nome" required />

    <label>Data:</label>
    <input type="date" name="data" id="data" min="{{ hoje }}" required />

    <label>Sala:</label>
    <select name="sala" id="sala" disabled required>
      <option disabled selected>Selecione a sala</option>
      {% for sala in salas %}
        <option value="{{ sala }}">{{ sala }}</option>
      {% endfor %}
    </select>

    <label>Hor√°rio de In√≠cio:</label>
    <select name="horario_inicio" id="horario_inicio" disabled required>
      <option disabled selected>Selecione um hor√°rio</option>
    </select>

    <label>Dura√ß√£o:</label>
    <select name="duracao" id="duracao" disabled required>
      <option disabled selected>Selecione uma dura√ß√£o</option>
    </select>

    <button type="submit">‚úÖ Confirmar Agendamento</button>
  </form>

  <script>
    const dataInput = document.getElementById("data");
    const salaSelect = document.getElementById("sala");
    const horarioSelect = document.getElementById("horario_inicio");
    const duracaoSelect = document.getElementById("duracao");
    const erroBox = document.getElementById("erro");

    const todasDuracoes = [
      { label: "30 minutos", value: 30 },
      { label: "1 hora", value: 60 },
      { label: "1 hora e 30 minutos", value: 90 },
      { label: "2 horas", value: 120 }
    ];

    function isWeekend(dateStr) {
      const [ano, mes, dia] = dateStr.split("-");
      const date = new Date(ano, mes - 1, dia);
      return date.getDay() === 0 || date.getDay() === 6;
    }

    function limparErros() {
      erroBox.textContent = "";
      erroBox.classList.add("hidden");
    }

    function carregarSalas() {
      const data = dataInput.value;
      limparErros();
      if (!data) return;

      if (isWeekend(data)) {
        salaSelect.innerHTML = "<option disabled selected>Selecione a sala</option>";
        salaSelect.disabled = true;
        horarioSelect.disabled = true;
        duracaoSelect.disabled = true;
        erroBox.textContent = "üö´ Ops! As salas n√£o est√£o dispon√≠veis aos s√°bados e domingos.";
        erroBox.classList.remove("hidden");
        return;
      }

      fetch(`/salas-disponiveis?data=${data}`)
        .then(r => r.json())
        .then(salas => {
          salaSelect.innerHTML = "<option disabled selected>Selecione a sala</option>";
          if (salas.length === 0) {
            salaSelect.disabled = true;
            horarioSelect.disabled = true;
            duracaoSelect.disabled = true;
            erroBox.textContent = "üòï Poxa, uma pena! N√£o temos mais salas/hor√°rios dispon√≠veis para essa data.";
            erroBox.classList.remove("hidden");
            return;
          }

          erroBox.classList.add("hidden");
          salas.forEach(sala => {
            const opt = document.createElement("option");
            opt.value = sala;
            opt.text = sala;
            salaSelect.appendChild(opt);
          });
          salaSelect.disabled = false;
        });
    }

    function carregarHorarios() {
      limparErros();
      const sala = salaSelect.value;
      const data = dataInput.value;
      const duracao = 30;

      fetch(`/horarios-disponiveis?sala=${sala}&data=${data}&duracao=${duracao}`)
        .then(r => r.json())
        .then(horarios => {
          horarioSelect.innerHTML = "<option disabled selected>Selecione um hor√°rio</option>";
          horarios.forEach(h => {
            const opt = document.createElement("option");
            opt.value = h;
            opt.text = h;
            horarioSelect.appendChild(opt);
          });
          horarioSelect.disabled = false;
          duracaoSelect.innerHTML = "<option disabled selected>Selecione uma dura√ß√£o</option>";
          duracaoSelect.disabled = true;
        });
    }

    function carregarDuracoes() {
      limparErros();
      const sala = salaSelect.value;
      const data = dataInput.value;
      const inicio = horarioSelect.value;

      duracaoSelect.innerHTML = "";
      duracaoSelect.disabled = false;

      todasDuracoes.forEach(d => {
        fetch(`/horarios-disponiveis?sala=${sala}&data=${data}&duracao=${d.value}`)
          .then(r => r.json())
          .then(horarios => {
            if (horarios.includes(inicio)) {
              const opt = document.createElement("option");
              opt.value = d.value;
              opt.text = d.label;
              duracaoSelect.appendChild(opt);
            }
          });
      });
    }

    dataInput.addEventListener("change", carregarSalas);
    salaSelect.addEventListener("change", carregarHorarios);
    horarioSelect.addEventListener("change", carregarDuracoes);

    window.addEventListener("pageshow", function (event) {
      try {
        const tipo = performance.getEntriesByType("navigation")[0]?.type || "navigate";
        if (event.persisted || tipo === "back_forward") {
          window.location.href = "/";
        } else {
          document.body.classList.remove("oculto");
        }
      } catch (e) {
        document.body.classList.remove("oculto");
      }
      setTimeout(() => document.body.classList.remove("oculto"), 100);
    });

    window.history.replaceState({}, document.title, "/");
  </script>
</body>
</html>
